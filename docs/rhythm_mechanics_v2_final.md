# 节律系统设计文档 · Rhythm Mechanics Design
### 天地万象 · Wanxiang — 核心玩法扩展（最终版）
### 版本 V2.1 · 2026.02.19

---

## 概述

天地万象引入两套与音乐节拍绑定的核心机制，将卡牌策略与音乐互动深度融合：

1. **天机抽牌（Reel Draw）** — 发牌阶段，3张手牌通过节拍点击抽取
2. **Boss战·限时出牌（Timed Play）** — Boss盲注阶段，限时出牌 + 节拍Bonus

两套系统共享同一个 **BeatClock（节律时钟）** 单例，为完整互动音乐系统奠基。

### 适用范围

| 机制 | 小盲注 | 大盲注 | Boss盲注 |
|:---|:---:|:---:|:---:|
| 天机抽牌 | ✅ | ✅ | ✅ |
| 限时出牌 | ❌ | ❌ | ✅ |
| 节拍Bonus | ❌ | ❌ | ✅ |

---

## 一、天机抽牌（Reel Draw）

### 1.1 核心流程

每轮发牌时，8张手牌的获取方式：

```
牌堆洗牌
  ├→ 5张自动发牌（传统随机抽取，带入场动画）
  └→ 3张天机抽牌（玩家依次点击抽取 A → B → C）
       ├→ A牌：1小节内牌面变换 4次（四分音符 ♩）
       ├→ B牌：1小节内牌面变换 8次（八分音符 ♪）
       └→ C牌：1小节内牌面变换 16次（十六分音符 ♬）
```

> **节拍倍增关系**：A → B → C = ×1 → ×2 → ×4，最自然的音乐倍率递进。

### 1.2 BPM与卦序对应

| 卦序(Ante) | BPM | 1小节时长 | A牌间隔(4次/小节) | B牌间隔(8次/小节) | C牌间隔(16次/小节) |
|:---:|:---:|:---:|:---:|:---:|:---:|
| 1 | 80 | 3.00s | 750ms | 375ms | 187ms |
| 2 | 88 | 2.73s | 682ms | 341ms | 170ms |
| 3 | 96 | 2.50s | 625ms | 312ms | 156ms |
| 4 | 104 | 2.31s | 577ms | 288ms | 144ms |
| 5 | 112 | 2.14s | 536ms | 268ms | 134ms |
| 6 | 120 | 2.00s | 500ms | 250ms | 125ms |
| 7 | 128 | 1.88s | 469ms | 234ms | 117ms |
| 8 | 136 | 1.76s | 441ms | 220ms | 110ms |

> **公式**：间隔 = 60 / BPM / (变换次数÷4)

### 1.3 抽牌循环数（Reel Cycles）

每张牌循环多个小节，给玩家足够的观察和决策时间：

| 抽牌 | 循环小节数 | 总变换次数 | 总时长(@80BPM) | 总时长(@136BPM) |
|:---:|:---:|:---:|:---:|:---:|
| A牌 | 4小节 | 16次 | 12.0s | 7.1s |
| B牌 | 3小节 | 24次 | 9.0s | 5.3s |
| C牌 | 2小节 | 32次 | 6.0s | 3.5s |

> 循环结束前未点击 → 自动取最后显示的牌面（不惩罚，但失去选择权）。

**天机抽牌总时长**：A(4) + B(3) + C(2) = **9小节**

| 卦序 | BPM | 9小节总时长 |
|:---:|:---:|:---:|
| 1 | 80 | 27.0s |
| 4 | 104 | 20.8s |
| 8 | 136 | 15.9s |

### 1.4 技巧与随机的平衡

| 抽牌 | 速度 | 玩家控制力 | 设计意图 |
|:---:|:---|:---|:---|
| A牌 | 四分音符（慢） | **高** — 清晰看到每张牌 | 人力可为（人道） |
| B牌 | 八分音符（中） | **中** — 能大致瞄准花色/范围 | 半人半天（修行） |
| C牌 | 十六分音符（快） | **低** — 几乎随机，凭直觉 | 天意难违（天道） |

> **哲学映射**：A/B/C = 人/地/天 = 三才。与易经"尽人事，听天命"一脉相承。

### 1.5 变换池机制

```
变换序列生成规则：
1. 从牌堆取出 N 张候选牌（N = 变换次数 × 2，确保多样性）
2. 随机排列为展示序列，循环播放
3. 玩家点击瞬间，当前显示的牌面即为抽取结果
4. 抽取的牌从牌堆移除
5. 未被选中的候选牌放回牌堆
```

### 1.6 视觉与音效

**视觉**：
- 卡牌在固定位置快速翻转/切换牌面
- 每次变换伴随轻微弹跳动画，与BeatClock严格同步
- A牌位置靠左，B牌居中，C牌靠右
- 当前待抽的牌位高亮/放大，其余暗淡
- 点击确认时0.2s freeze frame（慢动作定格）

**音效**：
- 每次牌面变换：轻击音效（与节拍同步）
- 玩家点击确认：重击音效
- A/B/C三次确认音效音高递升（如C3→E3→G3，形成大三和弦）

### 1.7 补牌阶段的天机抽牌

出牌后补牌默认为**普通随机抽取**（保持游戏节奏）。可通过异兽/天书解锁补牌天机能力：

| 来源 | 效果 |
|:---|:---|
| 异兽牌 | 补牌时额外进行1次天机抽牌（A级速度） |
| 天书 | 所有补牌变为天机抽牌（A级速度） |

---

## 二、Boss战·限时出牌（Timed Play）

### 2.1 核心规则

**仅在Boss盲注阶段生效**。

```
Boss战开始
  → 互动音乐启动（BPM与当前卦序对应）
  → 天机抽牌（A→B→C）
  → 每次出牌：16小节限时
  → 出牌瞬间的节拍位置决定Bonus等级
  → 弃牌不暂停计时，但补牌给予额外时间
  → 超时：强制出牌（方案A）
```

### 2.2 时间预算

| 卦序 | BPM | 16小节时长 | 玩家感受 |
|:---:|:---:|:---:|:---|
| 1 | 80 | 48.0s | 非常宽裕 |
| 2 | 88 | 43.6s | 宽裕 |
| 3 | 96 | 40.0s | 舒适 |
| 4 | 104 | 36.9s | 开始注意时间 |
| 5 | 112 | 34.3s | 中等压力 |
| 6 | 120 | 32.0s | 明显紧迫感 |
| 7 | 128 | 30.0s | 紧张 |
| 8 | 136 | 28.2s | 高压，必须果断 |

### 2.3 弃牌与时间经济（修订#1）

Boss战中，计时器**不因弃牌暂停**。弃牌后补牌给予额外时间：

**基础规则：每补1张牌 = +4小节**

| 弃牌张数 | 补牌数 | 额外小节 | @80BPM | @136BPM |
|:---:|:---:|:---:|:---:|:---:|
| 1 | 1 | +4 | +12.0s | +7.1s |
| 2 | 2 | +8 | +24.0s | +14.1s |
| 3 | 3 | +12 | +36.0s | +21.2s |

> **设计意图**：弃牌 = 花时间换更好的手牌。创造决策点：直接打次优牌 vs 花弃牌次数换时间+更好的牌。

**出牌后补牌**：出了几张补几张，计时器**重置为16小节**（新一轮出牌）。

### 2.4 Boss战Bonus得分模型（修订#4）

#### 核心概念：Bonus预算池

```
Boss目标满分 = 基础分(2/3) + Bonus池(1/3)
Bonus池 ÷ 出牌次数 = 每手Bonus上限
```

**纯Build能力决定基础分，节拍技巧决定Bonus分。两条路线互补，不互相替代。**

#### 节拍判定等级

玩家点击"出牌"的瞬间，判定与最近**强拍（第1拍和第3拍）**的时间差：

| 判定等级 | 时间差 | 获得Bonus | 视觉反馈 | 音效 |
|:---|:---:|:---:|:---|:---|
| **天合（Perfect）** | ≤ 40ms | 100% | 金色爆发 + 屏震 | 完美和弦 |
| **地应（Great）** | ≤ 100ms | 60% | 银色光环 | 清脆击打 |
| **人和（Good）** | ≤ 200ms | 30% | 铜色闪光 | 轻击 |
| **无感（Miss）** | > 200ms | 0% | 无特效 | 普通出牌音 |

#### 全8卦Boss数值表

| 卦序 | BPM | Boss目标满分 | 基础分(2/3) | Bonus池(1/3) | 每手Bonus上限(÷4) |
|:---:|:---:|:---:|:---:|:---:|:---:|
| 1 | 80 | 800 | 533 | 267 | 67 |
| 2 | 88 | 1,350 | 900 | 450 | 113 |
| 3 | 96 | 2,200 | 1,467 | 733 | 183 |
| 4 | 104 | 3,800 | 2,533 | 1,267 | 317 |
| 5 | 112 | 6,500 | 4,333 | 2,167 | 542 |
| 6 | 120 | 10,500 | 7,000 | 3,500 | 875 |
| 7 | 128 | 17,000 | 11,333 | 5,667 | 1,417 |
| 8 | 136 | 27,000 | 18,000 | 9,000 | 2,250 |

#### 示例：Ante 8 Boss战

```
Boss目标满分: 27,000
基础分要求:   18,000（纯Build能力）
Bonus池:      9,000
出牌4次，每手Bonus上限: 2,250

─ 第1手：同花顺 → 基础分 6,200 → 天合! +2,250 → 本手 8,450
─ 第2手：同花   → 基础分 4,100 → 地应  +1,350 → 本手 5,450
─ 第3手：葫芦   → 基础分 3,800 → 无感  +0     → 本手 3,800
─ 第4手：对子   → 基础分 1,900 → 人和  +675   → 本手 2,575

总分: 8,450 + 5,450 + 3,800 + 2,575 = 20,275
vs 目标 27,000 → ❌ 未达标（Build不够强）
```

> 这说明Ante 8即使有Bonus也需要很强的Build。纯节拍技巧不能替代Build。

### 2.5 超时处理（方案A · 强制出牌）

16小节结束时玩家未出牌：
- 系统自动使用当前选中的牌出牌
- 如果没有选中牌 → 使用最左边1张（高牌）
- 判定固定为「无感」（0 Bonus）
- 视觉：时钟碎裂特效 + 警告音

### 2.6 节拍指示器UI

```
╔═══════════════════════════════════════════════╗
║  ♩ ─── ♩ ─── ♩ ─── ♩ │ ♩ ─── ♩ ─── ♩ ─── ♩ ║
║              ↑ 当前拍                          ║
║  ████████████████░░░░░░░░░░░░  10/16 小节      ║
╚═══════════════════════════════════════════════╝

- 节拍点以脉冲光点表示，当前拍高亮
- 强拍（第1、3拍）光点更大，标记为判定点
- 16小节进度条，最后4小节变红+脉冲加速
- 强拍时UI微微"呼吸"（缩放0.98-1.02）
```

### 2.7 Boss战计分显示

```
┌─────────────────────────┐
│  同花  Lv.3             │
│  Chips: 185  Mult: ×47  │
│  ─────────────          │
│  基础分: 8,695          │
│  🎵 天合! +2,250 Bonus  │
│  ═══════════════        │
│  本手总分: 10,945       │
│                         │
│  本轮: 24,830 / 27,000  │
│  ████████████████░░░░   │
└─────────────────────────┘
```

---

## 三、Boss战完整流程

以Ante 4（BPM 104，4次出牌，3次弃牌）为例：

```
═══ Boss战开始 · BPM 104 ═══

── 天机抽牌（9小节 ≈ 20.8s）──
  5张自动发牌
  A牌（4小节循环）→ 点击 → 确定
  B牌（3小节循环）→ 点击 → 确定
  C牌（2小节循环）→ 点击 → 确定
  8张手牌就位

── 第1次出牌 ──
  ⏱️ 16小节计时开始（36.9s）
  观察手牌...弃2张
  → 补2张 → 计时器 +8小节
  选5张 → 出牌!
  🎵 天合! +317 Bonus!
  → 补5张 → 计时器重置16小节

── 第2次出牌 ──
  ⏱️ 16小节
  不弃牌，直接出
  🎵 地应! +190 Bonus!
  → 补牌 → 重置

── 第3次出牌 ──
  ⏱️ 16小节
  弃1张 → +4小节
  🎵 人和! +95 Bonus!
  → 补牌 → 重置

── 第4次出牌（最后一手）──
  ⏱️ 16小节
  🎵 无感 +0
  
═══ Boss战结算 ═══
  基础分合计 + Bonus合计 vs 目标
```

---

## 四、节律系统对异兽牌的影响

### 4.1 新增效果维度：「律」系效果

72张异兽牌中划出**10张**作为律系效果（5张抽牌系 + 5张战斗系），从其他类型各减1-2张。

#### 修订后的72张分配

| 效果类型 | 数量 | 变化 |
|:---|:---:|:---|
| 基础加成型 | 8 | -2 |
| 花色触发型 | 8 | 不变 |
| 牌型触发型 | 7 | -1 |
| 点数条件型 | 6 | -1 |
| 上下文条件型 | 5 | -1 |
| 经济型 | 7 | -1 |
| 自毁/牺牲型 | 5 | -1 |
| 复制/模仿型 | 4 | 不变 |
| 重触发型 | 6 | -1 |
| 递增/累积型 | 6 | -2 |
| **律·天机系（新）** | **5** | 🆕 |
| **律·战时系（新）** | **5** | 🆕 |
| **合计** | **72** | |

### 4.2 律·天机系（5张）— 抽牌相关

| 名称概念 | 稀有度 | 效果 |
|:---|:---:|:---|
| 凝时 | 凡兽 | A牌变换速度减半（4次→2次/小节） |
| 封神引 | 灵兽 | A牌变换池只出现人头牌(J/Q/K/A) |
| 锁象 | 灵兽 | A牌变换池只出现指定四象花色 |
| 余韵 | 灵兽 | 补牌时额外进行1次A级天机抽牌 |
| 天机四抽 | 传说 | 天机抽牌变为4次(A/B/C/D)，D级=四分音符速度 |

### 4.3 律·战时系（5张）— Boss限时相关

| 名称概念 | 稀有度 | 效果 |
|:---|:---:|:---|
| 延时 | 凡兽 | Boss战出牌时限+4小节(16→20) |
| 多息 | 凡兽 | 每次补牌额外+2小节(4→6/张) |
| 缓律 | 灵兽 | Boss战BPM降低1档(如136→128) |
| 脉动 | 神兽 | 计时期间每过1小节+3 Mult（等越久越强） |
| 天籁 | 传说 | Perfect的Bonus从100%→200% |

### 4.4 其他卡牌类型中的律系效果

#### 法宝牌（36张中建议3-4张律系）

| 名称概念 | 分类 | 效果 |
|:---|:---|:---|
| 定时神针 | 法宝 | 本轮Boss战时限+8小节 |
| 慢光镜 | 法宝 | 本轮天机抽牌全部减速至A级（四分音符） |
| 时停阵 | 阵法 | 本卦Boss战无时间限制 |
| 天音阵 | 阵法 | 本卦所有节拍判定视为Perfect |

#### 天书（16卷中建议2对律系）

| 名称概念 | 层级 | 效果 |
|:---|:---|:---|
| 律令·基础 | 基础 | 节拍判定窗口永久扩大30% |
| 律令·进阶 | 进阶 | Perfect的Bonus从100%提升到150% |
| 天机·基础 | 基础 | A牌循环+2小节 |
| 天机·进阶 | 进阶 | 补牌时获得1次A级天机抽牌 |

### 4.5 弃牌时间的衍生异兽效果

弃牌=时间的规则创造了专属效果空间：

| 名称概念 | 稀有度 | 效果 | 设计意图 |
|:---|:---:|:---|:---|
| 缓息 | 灵兽 | 每次补牌+4额外小节(4→8/张) | 弃牌更有价值 |
| 急流 | 灵兽 | 补牌时间减半(4→2/张)，但补的牌获得箔片 | 时间换增强 |
| 止水 | 神兽 | 弃牌阶段完全暂停计时 | 极强时间控制 |

> 这些可归入上下文条件型或律·战时系，具体分配在逐张设计时确定。

---

## 五、新增代码枚举汇总

### 5.1 BeatClock相关

```gdscript
# beat_clock.gd — AutoLoad 单例
extends Node

signal beat_hit(beat_index: int, is_strong: bool)
signal measure_end(measure_index: int)
signal reel_tick(reel_slot: int, card_index: int)
signal timer_expired()

var bpm: float = 80.0
var beat_interval: float = 0.75    # 60.0 / bpm
var current_beat: int = 0          # 0-3 (4/4拍)
var current_measure: int = 0
var is_playing: bool = false
var elapsed: float = 0.0

# Boss战
var boss_timer_measures: int = 16
var boss_timer_active: bool = false
var boss_measures_elapsed: int = 0

# 天机抽牌
var reel_active: bool = false
var reel_current_slot: int = 0     # 0=A, 1=B, 2=C

# BPM映射表
const BPM_TABLE: Array = [80, 88, 96, 104, 112, 120, 128, 136]

func set_ante_bpm(ante: int) -> void:
    var idx = clampi(ante - 1, 0, BPM_TABLE.size() - 1)
    bpm = BPM_TABLE[idx]
    beat_interval = 60.0 / bpm
```

### 5.2 节拍判定

```gdscript
func judge_beat_timing() -> Dictionary:
    # 计算到最近强拍（第1、3拍）的距离
    var strong_beat_interval = beat_interval * 2.0
    var time_in_strong = fmod(elapsed, strong_beat_interval)
    var distance = minf(time_in_strong, strong_beat_interval - time_in_strong)
    
    var grade: String
    var bonus_ratio: float
    
    if distance <= 0.040:
        grade = "perfect"
        bonus_ratio = 1.0
    elif distance <= 0.100:
        grade = "great"
        bonus_ratio = 0.6
    elif distance <= 0.200:
        grade = "good"
        bonus_ratio = 0.3
    else:
        grade = "miss"
        bonus_ratio = 0.0
    
    return {
        "grade": grade,
        "bonus_ratio": bonus_ratio,
        "distance_ms": distance * 1000.0
    }
```

### 5.3 异兽牌新增枚举

```gdscript
# 新增 TriggerType
ON_REEL_DRAW         # 天机抽牌时触发
ON_PERFECT_HIT       # 打出Perfect判定时触发
ON_BEAT              # 每个节拍触发（被动累积型）

# 新增 EffectType
MODIFY_REEL_SPEED    # 修改变换速度（value=倍率，0.5=减半）
MODIFY_REEL_POOL     # 修改变换池（condition决定过滤方式）
EXTRA_REEL_DRAW      # 额外天机抽牌次数
MODIFY_TIMER         # 修改Boss战时限（value=额外小节数）
MODIFY_BPM           # 修改BPM（value=偏移量，负值=减速）
MODIFY_JUDGE_WINDOW  # 修改判定窗口（value=倍率）
BONUS_MULTIPLIER     # 修改Bonus比例
BEAT_ACCUMULATE      # 每拍累积效果

# 新增 ConditionType
REEL_SLOT            # 特定抽牌位(A=0, B=1, C=2)
BEAT_TIMING          # 判定结果(0=Miss, 1=Good, 2=Great, 3=Perfect)
CONSECUTIVE_PERFECT  # 连续Perfect次数
```

---

## 六、实现优先级

| 优先级 | 模块 | 依赖 | 工作量 |
|:---|:---|:---|:---:|
| P0 | BeatClock单例（BPM/拍号/信号） | 无 | 小 |
| P1 | 天机抽牌核心（A/B/C变换+点击） | BeatClock | 中 |
| P1 | Boss战计时器（16小节+弃牌补时） | BeatClock | 中 |
| P2 | 节拍Bonus判定+Bonus预算池 | BeatClock | 中 |
| P2 | 节拍指示器UI | BeatClock | 小 |
| P3 | 互动音乐集成（BPM同步） | BeatClock + 音频资源 | 大 |
| P3 | 律系异兽效果实现 | 异兽系统 + BeatClock | 大 |

> **建议**：先实现BeatClock + 天机抽牌（用metronome音效代替音乐），验证手感后再接入完整音乐。

---

## 七、文化映射总结

| 机制 | 文化内涵 |
|:---|:---|
| 天机抽牌 A/B/C | 人/地/天 三才 → 人力可为、半人半天、天意难违 |
| 节拍倍增 ×1→×2→×4 | 道生一，一生二，二生三 → 自然的层级递进 |
| BPM随卦序递增 | 修行越深，天道运转越快 → 越考验心性 |
| 16小节时限 | 16 = 天书数（8×2）→ 天道给予的有限窗口 |
| 天合/地应/人和 | 三才合一的修行境界 → 天人合一 |
| 弃牌换时间 | 舍得 → 有舍才有得，道家核心智慧 |
| Boss战互动音乐 | 道法自然，万物有律 → 与天地同频共振 |
| Bonus预算池(1/3) | 天地人各占三分 → 技巧与Build各有其分 |
